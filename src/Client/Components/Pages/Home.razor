@page "/"
@inject HttpClient HttpClient

<PageTitle>Главная — CatStore</PageTitle>

<div class="grid grid-cols-12 xl:gap-5 gap-4">
    <Panel CssClasses="flex flex-col xl:gap-4 gap-3 lg:flex hidden col-span-3">
        <div class="flex flex-col gap-2">
            <h2>Цена</h2>
            <InputField InputType="number" Placeholder="От 199"/>
            <InputField InputType="number" Placeholder="До 499"/>
        </div>

        <div class="flex flex-col gap-2">
            <h2>Пол</h2>
            <RadioButton Text="Любой" Name="gender" Checked />
            <RadioButton Text="Мальчик" Name="gender" />
            <RadioButton Text="Девочка" Name="gender" />
        </div>

        <div class="flex flex-col gap-2">
            <h2 >Цвет</h2>
            <RadioButton Text="Любой" Name="color" Checked />
            <RadioButton Text="Черный" Name="color" />
            <RadioButton Text="Белый" Name="color" />
            <RadioButton Text="Красный" Name="color" />
            <RadioButton Text="Оранжевый" Name="color" />
            <RadioButton Text="Желтый" Name="color" />
            <RadioButton Text="Зеленый" Name="color" />
            <RadioButton Text="Синий" Name="color" />
            <RadioButton Text="Фиолетовый" Name="color" />
        </div>

        <div class="flex flex-col gap-2">
            <ApplyButton>Применить</ApplyButton>
            <Button>Сбросить</Button>
        </div>
    </Panel>

    <div class="lg:col-span-9 col-span-12 flex flex-col xl:gap-5 gap-4">
        <Panel CssClasses="h-16">
            <div class="w-52">
                <SortDropdown @bind-Value="SortType">
                    <option value="cheap">Сначала дешевые</option>
                    <option value="expensive">Сначала дорогие</option>
                </SortDropdown>
            </div>
        </Panel>

        @if (Cats.Count > 0)
        {
            <div class="grid xl:grid-cols-4 grid-cols-3 auto-rows-min xl:gap-5 gap-4">
                @foreach(var cat in GetCats(Name, SortType))
                {
                    <CatCard @key="cat" Cat="cat" />
                }
            </div>
        }
        else if (HasDataLoaded)
        {
            <h1 class="text-sm">Каталог пуст. Перейдите на страницу <a class="text-primary hover:cursor-pointer hover:underline" href="/products">управления товарами</a>, чтобы добавить котов.</h1>
        }
    </div>
</div>

@code {
    private List<CatResponse> Cats { get; set; } = new();
    private bool HasDataLoaded { get; set; }

    [SupplyParameterFromQuery]
    public string? Name { get; set; }
    private string SortType { get; set; } = "cheap";

    protected override async Task OnInitializedAsync()
    {
        Cats = await HttpClient.GetFromJsonAsync<List<CatResponse>>("/api/cats") ?? new List<CatResponse>();
        HasDataLoaded = true;
    }

    private List<CatResponse> GetCats(string? name, string sortType)
    {
        var cats = Cats;

        if (name != null)
            cats = Cats.Where(cat => cat.Name.ToLower().Contains(name.ToLower())).ToList();

        Func<List<CatResponse>> sortMethod = sortType switch
        {
            "cheap"     => () => cats.OrderBy(cat => (int)cat.Cost - (int)cat.Discount).ToList(),
            "expensive" => () => cats.OrderByDescending(cat => (int)cat.Cost - (int)cat.Discount).ToList(),
            _           => () => cats
        };

        return sortMethod.Invoke();
    }
}